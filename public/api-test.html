<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>API æµ‹è¯•</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #1a1a2e;
      color: #eee;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    .test-button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      cursor: pointer;
      margin-right: 10px;
      margin-bottom: 10px;
      border-radius: 4px;
    }
    .test-button:hover {
      background: #45a049;
    }
    .log {
      background: #16213e;
      border: 1px solid #0f3460;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      max-height: 400px;
      overflow-y: auto;
    }
    .log-entry {
      margin: 5px 0;
      padding: 5px;
      border-bottom: 1px solid #0f3460;
    }
    .success { color: #4CAF50; }
    .error { color: #f44336; }
    .info { color: #2196F3; }
    .url-input {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      font-size: 14px;
      background: #16213e;
      border: 1px solid #0f3460;
      color: #eee;
      border-radius: 4px;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ§ª API è¿žæŽ¥æµ‹è¯•å·¥å…·</h1>

    <div>
      <label>API URL:</label>
      <input type="text" id="apiUrl" class="url-input" value="http://localhost:8080/api/categories" />
    </div>

    <div>
      <button class="test-button" onclick="testFetch()">æµ‹è¯• Fetch</button>
      <button class="test-button" onclick="testXHR()">æµ‹è¯• XHR</button>
      <button class="test-button" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <div class="log" id="log"></div>
  </div>

  <script>
    const log = document.getElementById('log');
    const apiUrlInput = document.getElementById('apiUrl');

    function addLog(message, type = 'info') {
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      const timestamp = new Date().toLocaleTimeString();
      entry.textContent = `[${timestamp}] ${message}`;
      log.appendChild(entry);
      log.scrollTop = log.scrollHeight;
    }

    function clearLog() {
      log.innerHTML = '';
    }

    async function testFetch() {
      const url = apiUrlInput.value;
      addLog(`å¼€å§‹ Fetch æµ‹è¯•...`, 'info');
      addLog(`URL: ${url}`, 'info');

      try {
        const startTime = Date.now();
        addLog('å‘é€è¯·æ±‚...', 'info');

        const response = await fetch(url);
        const duration = Date.now() - startTime;

        addLog(`å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
        addLog(`è€—æ—¶: ${duration}ms`, 'info');

        const data = await response.json();
        addLog(`å“åº”æ•°æ®: ${JSON.stringify(data, null, 2)}`, 'success');
      } catch (error) {
        addLog(`é”™è¯¯: ${error.message}`, 'error');

        if (error instanceof TypeError) {
          addLog('TypeError: å¯èƒ½æ˜¯ç½‘ç»œè¿žæŽ¥ã€CORS æˆ– URL æ ¼å¼é—®é¢˜', 'error');

          // æ£€æŸ¥å¸¸è§é—®é¢˜
          if (error.message.includes('Failed to fetch')) {
            addLog('è¯Šæ–­:', 'error');
            addLog('- æ£€æŸ¥åŽç«¯æœåŠ¡æ˜¯å¦å¯åŠ¨ (http://localhost:8080)', 'error');
            addLog('- æ£€æŸ¥æµè§ˆå™¨æŽ§åˆ¶å° Network æ ‡ç­¾', 'error');
            addLog('- æ£€æŸ¥ CORS é…ç½®', 'error');
            addLog('- å°è¯•ä½¿ç”¨ curl æˆ– postman æµ‹è¯•', 'error');
          }
        }

        console.error('Full error:', error);
      }
    }

    function testXHR() {
      const url = apiUrlInput.value;
      addLog(`å¼€å§‹ XHR æµ‹è¯•...`, 'info');
      addLog(`URL: ${url}`, 'info');

      const xhr = new XMLHttpRequest();
      const startTime = Date.now();

      xhr.open('GET', url);

      xhr.onload = function() {
        const duration = Date.now() - startTime;
        addLog(`XHR å“åº”çŠ¶æ€: ${xhr.status} ${xhr.statusText}`, xhr.status === 200 ? 'success' : 'error');
        addLog(`è€—æ—¶: ${duration}ms`, 'info');
        addLog(`å“åº”æ•°æ®: ${xhr.responseText.substring(0, 500)}...`, 'success');
      };

      xhr.onerror = function() {
        addLog('XHR è¯·æ±‚å¤±è´¥', 'error');
        addLog(`é”™è¯¯è¯¦æƒ…: ${xhr.status} ${xhr.statusText}`, 'error');
      };

      xhr.onabort = function() {
        addLog('XHR è¯·æ±‚è¢«ä¸­æ­¢', 'error');
      };

      xhr.ontimeout = function() {
        addLog('XHR è¯·æ±‚è¶…æ—¶', 'error');
      };

      xhr.timeout = 10000; // 10ç§’è¶…æ—¶

      addLog('å‘é€ XHR è¯·æ±‚...', 'info');
      xhr.send();
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•
    window.onload = function() {
      addLog('é¡µé¢å·²åŠ è½½ï¼Œç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•', 'info');
      addLog('å½“å‰æµè§ˆå™¨:', 'info');
      addLog(`- User Agent: ${navigator.userAgent.substring(0, 100)}...`, 'info');

      // æ£€æŸ¥æ˜¯å¦åœ¨æœ¬åœ°çŽ¯å¢ƒ
      if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
        addLog('âœ“ è¿è¡Œåœ¨æœ¬åœ°çŽ¯å¢ƒ', 'success');
      } else {
        addLog(`âš ï¸ è¿è¡Œåœ¨: ${location.hostname}`, 'info');
      }

      // è‡ªåŠ¨æµ‹è¯•ä¸€æ¬¡
      setTimeout(() => {
        addLog('è‡ªåŠ¨æ‰§è¡Œä¸€æ¬¡æµ‹è¯•...', 'info');
        testFetch();
      }, 1000);
    };
  </script>
</body>
</html>
